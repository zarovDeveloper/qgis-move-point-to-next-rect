# QGIS Move Point to Next Rectangle

PyQGIS скрипт для циклического перемещения точечных объектов между последовательно расположенными прямоугольниками.

## Описание

Скрипт выполняет следующие операции:
- Загружает указанные слои с точками и прямоугольниками (.gpkg).
- Определяет последовательность прямоугольников, сортируя их по X-координате.
- Для каждого объекта точечного слоя определяет, в каком из прямоугольников он находится.
- Циклически перемещает точки из прямоугольника `i` в прямоугольник `i+1`. Точки из последнего прямоугольника перемещаются в первый.
- Перед применением изменений выводит в консоль план перемещений и запрашивает подтверждение у пользователя.

## Требования

- QGIS 3.x, установленный в системе.
- Python 3.9+ (с поддержкой современных аннотаций типов).
- Poetry для управления зависимостями.
- ruff для форматирования и линтинга кода.

## Установка проекта

1. **Клонируйте репозиторий:**
   ```bash
   git clone <repository-url>
   cd qgis-move-point-to-next-rect
   ```

2. **Установите зависимости через Poetry:**
   ```bash
   make install
   ```

3. **Убедитесь, что QGIS установлен в системе.**

## Использование Make-команд

Проект включает удобный Makefile для автоматизации задач.

### Основные команды

- **`make help`** - показать все доступные команды.
- **`make format`** - форматирование кода с помощью `ruff`.
- **`make lint`** - проверка кода на ошибки.
- **`make check`** - полная проверка (lint + format check).
- **`make fix`** - автоматическое исправление проблем.
- **`make clean`** - очистка временных файлов.

### Запуск скрипта

- **`make run`** - запуск скрипта с тестовыми данными (`data/points.gpkg` и `data/rectangles.gpkg`).
- **`make run-help`** - показать справку по использованию скрипта.

### Примеры использования

```bash
# Установка зависимостей
make install

# Форматирование и проверка кода
make format
make lint

# Запуск с тестовыми данными
make run

# Получение справки по скрипту
make run-help

# Полная проверка перед коммитом
make check
```

## Прямой запуск скрипта

Вы можете запустить скрипт напрямую с вашими данными:

```bash
# Через QGIS Python (рекомендуется)
/Applications/QGIS-LTR.app/Contents/MacOS/bin/python3 src/move_point.py --points /path/to/your_points.gpkg --rects /path/to/your_rects.gpkg

# Справка по параметрам
/Applications/QGIS-LTR.app/Contents/MacOS/bin/python3 src/move_point.py --help
```

## Структура проекта

```
qgis-move-point-to-next-rect/
├── data/                           # Тестовые данные
│   ├── points.gpkg                 # Слой с точками
│   └── rectangles.gpkg             # Слой с прямоугольниками
├── src/                            # Исходный код
│   └── move_point.py               # Основной скрипт
├── Makefile                        # Автоматизация задач
├── pyproject.toml                  # Конфигурация Poetry
├── poetry.lock                     # Зафиксированные версии зависимостей
└── README.md                       # Документация
```

## Особенности кода

- **Модульная архитектура** - код разбит на специализированные функции.
- **Аннотации типов** - для всех функций используются современные типы.
- **Интерактивное подтверждение** - скрипт запрашивает разрешение перед изменением данных.
- **Подробное логирование** - информация о каждом этапе обработки выводится в консоль.

## Результат работы

После успешного выполнения скрипта:
- Объекты точечного слоя будут перемещены в следующие по порядку прямоугольники.
- В консоли будет выведен отчет о выполненных перемещениях.

## Возможные ошибки

- **"Файл не найден"** - убедитесь, что указанные файлы .gpkg существуют.
- **"Нет точек для перемещения"** - в исходных прямоугольниках не найдено точечных объектов.
- **"ModuleNotFoundError: No module named 'qgis'"** - убедитесь, что используете интерпретатор Python из дистрибутива QGIS.
- **"usage: move_point.py [-h] --points POINTS --rects RECTS"** - не указаны обязательные аргументы `--points` или `--rects`.
- **Segmentation Fault** - обычно возникает из-за некорректного управления памятью. Убедитесь, что объекты слоев удаляются перед выходом из QGIS API.

## Разработка

Для разработки рекомендуется использовать Make-команды:

```bash
# Перед началом работы
make install

# Во время разработки
make format  # форматирование
make lint    # проверка ошибок
make run     # тестирование

# Перед коммитом
make check   # полная проверка
```
